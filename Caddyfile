# ============================================
# GiLo AI — Caddy Reverse Proxy Configuration
# Handles wildcard subdomain routing for deployed agents
# ============================================

# Main domain: serves the frontend + API
{$GILO_DOMAIN:gilo.dev} {
	tls {$TLS_EMAIL:admin@gilo.dev} {
		dns godaddy {$GODADDY_API_KEY:}
	}

	# API routes → backend
	handle /api/* {
		reverse_proxy backend:3001
	}

	handle /health {
		reverse_proxy backend:3001
	}

	# Everything else → frontend
	handle {
		reverse_proxy frontend:5173
	}
}

# Wildcard subdomains: route {slug}.gilo.dev to the backend
*.{$GILO_DOMAIN:gilo.dev} {
	tls {$TLS_EMAIL:admin@gilo.dev} {
		dns godaddy {$GODADDY_API_KEY:}
	}

	reverse_proxy backend:3001
}

# Local development fallback (port 80, when no domain configured)
:80 {
	# Health check
	handle /health {
		reverse_proxy backend:3001
	}

	# API routes → backend
	handle /api/* {
		reverse_proxy backend:3001
	}

	# Everything else → frontend
	handle {
		reverse_proxy frontend:5173
	}
}
